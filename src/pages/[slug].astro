---
import DefaultLayout from "../layouts/DefaultLayout.astro"
import Component from "../components/Component.jsx"

export async function getStaticPaths() {
  const key = "BZX4R4Dr8Y6rnegRb9YaPwtt"
  const cacheBuster = new Date().getMilliseconds()
  const dev = process.env.npm_lifecycle_script !== 'astro dev'
  const home = dev ? 'home,' : ''

  const { stories } = await fetch(`https://api.storyblok.com/v2/cdn/stories/?excluding_slugs=${home}settings&token=${key}&cv=${cacheBuster}`)
	  .then(response => response.json());

  return stories.map((story) => {
    return {
      params: { slug: story.slug },
      props: { story }
    };
  });
}

const { story } = Astro.props;

const clientScript = (component) => {
  const body = JSON.stringify(story.content.body)
  const c = component.toLowerCase()
  if (body.includes(`"component":"${component}"`)) {
    return (
      <script src={Astro.resolve(`../js/${c}.js`)} defer type="module"></script>
    )
  }
}
---
<DefaultLayout 
  title={story.content.SEO.title || story.name}
  description={story.content.SEO.description || ""}
>
  {story.content.body.map(child => {
    return <Component blok={child}/>
  })}
  {clientScript('Form')}
  {clientScript('Tabs')}
</DefaultLayout>