---
import BaseHead from '../components/BaseHead.astro';
import AppBar from '../components/AppBar';
import AppDrawer from '../components/AppDrawer';
import Component from '../components/Component'
import Theme from '../components/Theme'

const { story } = Astro.props;
const key = "BZX4R4Dr8Y6rnegRb9YaPwtt"
const cacheBuster = new Date().getMilliseconds()
const settings = await fetch(`https://api.storyblok.com/v2/cdn/stories/settings?token=${key}&version=draft&cv=${cacheBuster}`)
  .then(response => response.json());
const global = settings.story.content
---
<html lang="en">

  <head>
    <BaseHead global={ global } story={ story }/>
    <style lang="scss" global>
      @import "../css/base.scss";
    </style>
    <Theme global={ global }/>
  </head>

  <body class={ process.env.npm_lifecycle_script }>

    <AppDrawer global={ global }/>
    <AppBar global={ global }/>
    
    <slot/>

    {global.footer.map(content => (
      <Component blok={ content }/>
    ))}

    <!-- Load Images -->
    <script src={Astro.resolve('../js/images.js')}></script>

    <!-- Activate the Drawer -->
    <script type="module" src={Astro.resolve('../js/drawer.js')}></script>

    <!-- Settings Redirect -->
    <script>
      if (window.location.pathname === "/settings") {
        window.location.replace("http://localhost:3000")
      }
    </script>

    <!-- Deferred Crap like Fonts -->
    { global.custom_html }

  </body>

</html>

